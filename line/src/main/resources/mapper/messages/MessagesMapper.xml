<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.00//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dudgkr.line.db.model.messages.mapper.MessagesMapper">

    <insert id="saveMessage" parameterType="MessagesDto">
        INSERT INTO messages (sender_id, receiver_id, message_content, timestamp, read_status)
        VALUES (#{senderId}, #{receiverId}, #{message}, NOW(), FALSE);
    </insert>


    <select id="fetchMessage" parameterType="MessagesDto" resultType="MessagesDto">
        SELECT * FROM messages
        WHERE (sender_id = #{senderId} AND receiver_id = #{receiverId}) OR (sender_id = #{receiverId} AND receiver_id = #{senderId})
        ORDER BY timestamp ASC;
    </select>


    <!-- 각 채팅방 별로 가장 최근 메시지 가져오기-->
    <select id="fetchLatestMessagePerChatRoom" parameterType="UserDto" resultType="MessagesDto">
        SELECT * FROM messages
        WHERE message_id IN (
            SELECT MAX(message_id)
            FROM messages
            WHERE sender_id = #{id} OR receiver_id = #{id}
            GROUP BY CASE
                         WHEN sender_id = #{id} THEN receiver_id
                         ELSE sender_id
                         END
        )
        ORDER BY timestamp DESC;
    </select>

</mapper>
